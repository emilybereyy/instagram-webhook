from flask import Flask, request
import requests
import sqlite3
import os

app = Flask(__name__)

# Токены
TG_TOKEN = os.getenv("TG_TOKEN")
TG_CHAT_ID = os.getenv("TG_CHAT_ID")  # ID чата для отправки сообщений
TELEGRAM_API = f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage"

# Instagram
VERIFY_TOKEN = os.getenv("VERIFY_TOKEN")
IG_ACCESS_TOKEN = os.getenv("IG_ACCESS_TOKEN")
GRAPH_API_URL = "https://graph.facebook.com/v18.0"

# Создаем подключение к базе данных SQLite
db = sqlite3.connect('mapping.db', check_same_thread=False)
c = db.cursor()

# Создаем таблицу для хранения связи между пользователями Instagram и сообщениями Telegram
c.execute('''
CREATE TABLE IF NOT EXISTS user_map (
                ig_user_id TEXT,
                tg_message_id INTEGER
            )
''')
db.commit()

@app.route("/")
def home():
    return "Bot is running!"

@app.route("/instagram", methods=["GET", "POST"])
def instagram_webhook():
    if request.method == "GET":
        mode = request.args.get("hub.mode")
        token = request.args.get("hub.verify_token")
        challenge = request.args.get("hub.challenge")
        if mode == "subscribe" and token == VERIFY_TOKEN:
            return challenge, 200
        return "Forbidden", 403

    if request.method == "POST":
        data = request.json
        print("Incoming IG Message:", data)

        # Перебираем все входящие сообщения
        for entry in data.get("entry", []):
            for messaging in entry.get("messaging", []):
                sender_id = messaging["sender"]["id"]
                message_text = messaging["message"].get("text")
                if message_text:
                    tg_response = requests.post(TELEGRAM_API, json={
                        "chat_id": TG_CHAT_ID,
                        "text": f"Instagram user {sender_id} says: {message_text}"
                    })
                    c.execute("INSERT INTO user_map (ig_user_id, tg_message_id) VALUES (?, ?)", (sender_id, tg_response.json().get("message_id")))
                    db.commit()
        return "OK", 200

@app.route("/telegram", methods=["POST"])
def telegram_webhook():
    data = request.json
    print("Incoming TG Message:", data)

    message = data.get("message")
    if message and message.get("reply_to_message"):
        reply_text = message.get("text")
        replied_message_text = message["reply_to_message"]["text"]

        # Извлекаем IG user ID из ответа
        if "Instagram user" in replied_message_text:
            ig_user_id = replied_message_text.split()[2]
            send_instagram_message(ig_user_id, reply_text)

    return "OK", 200

def send_instagram_message(ig_user_id, message):
    url = f"{GRAPH_API_URL}/{ig_user_id}/messages"
    payload = {
        "messaging_type": "RESPONSE",
        "recipient": {"id": ig_user_id},
        "message": {"text": message},
        "access_token": IG_ACCESS_TOKEN
    }
    response = requests.post(url, json=payload)
    print("IG Response:", response.text)

if __name__ == "__main__":
    app.run(debug=True)
